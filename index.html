<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Etiquetas Avançado</title>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <style>
        :root {
            /* --- Variáveis de Layout --- */
            --toolbar-height: 60px; /* Altura da barra de ferramentas principal */
            --secondary-toolbar-height: 50px; /* Altura das barras secundárias */
            --left-toolbar-width: 55px; /* NOVO: Largura da barra de ferramentas esquerda */
            
            /* --- Variáveis de Tamanho da Etiqueta (controladas por JS) --- */
            --label-width: 100mm;
            --label-height: 50mm;
            --label-gap: 5mm; 
            
            /* --- Variáveis de Impressão (controladas por JS) --- */
            --print-page-width: var(--label-width);
            --print-page-height: var(--label-height);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #F0F2F5;
            margin: 0;
            /* MODIFICADO: Espaço agora é gerenciado pelo #main-content-wrapper */
            /* padding-top: calc(var(--toolbar-height) + var(--secondary-toolbar-height)); */
            padding-bottom: 30px;
            display: flex; /* NOVO: Ativa layout flex para barra lateral */
        }

        /* --- NOVA Barra de Ferramentas Vertical (Esquerda) --- */
        #left-toolbar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: var(--left-toolbar-width); /* Largura da barra de ferramentas */
            background-color: #4a4a4a; /* Cor escura (Photoshop-like) */
            padding: 10px 5px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            z-index: 200;
            box-shadow: 2px 0 5px rgba(0,0,0,0.15);
            overflow-y: auto; /* Permite rolagem se tiver muitos botões */
        }
        #left-toolbar .button-group {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 8px;
        }
        #left-toolbar button,
        #left-toolbar select {
            width: 100%;
            height: 40px;
            padding: 8px;
            justify-content: center;
            background-color: #5f5f5f;
            border: 1px solid #777;
            color: #f1f1f1;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
            white-space: nowrap;
        }
        #left-toolbar button .material-icons,
        #left-toolbar select .material-icons {
            color: #f1f1f1;
            margin: 0; /* Remove gap interno */
            font-size: 20px;
        }
        #left-toolbar .label {
            display: none; /* Esconde o label "Adicionar:" */
        }
        #left-toolbar button:hover,
        #left-toolbar select:hover {
            background-color: #777;
            border-color: #999;
        }
        /* Ajuste para select (seta) */
        #left-toolbar .select-wrapper {
            position: relative;
            width: 100%;
        }

        #left-toolbar .select-wrapper .select-icon {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: #f1f1f1;
            font-size: 20px;
            pointer-events: none;
        }

        #left-toolbar select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none; /* Remove default arrow */
            padding-left: 32px; /* Space for the icon */
        }
        /* Ajuste específico para o botão de remover */
        #left-toolbar #btn-remover-item {
            margin-top: auto; /* Empurra para o final da barra */
            background-color: #a13a3a;
            border-color: #c05050;
        }
        #left-toolbar #btn-remover-item:hover {
            background-color: #c05050;
        }

        /* --- NOVO: Wrapper do Conteúdo Principal (Direita) --- */
        #main-content-wrapper {
            flex-grow: 1; /* Ocupa o resto do espaço */
            margin-left: var(--left-toolbar-width); /* Espaço para a barra esquerda */
            padding-top: calc(var(--toolbar-height) + var(--secondary-toolbar-height)); /* Espaço para as barras superiores */
            width: calc(100% - var(--left-toolbar-width));
            box-sizing: border-box;
            position: relative; /* Para que o canvas de desenho se posicione corretamente */
        }


        /* --- Barra de Ferramentas Fixa (Principal) --- */
        #toolbar {
            position: fixed;
            top: 0;
            /* MODIFICADO: left: 0; -> left: var(--left-toolbar-width); */
            left: var(--left-toolbar-width);
            /* MODIFICADO: width: 100%; -> width: calc(100% - var(--left-toolbar-width)); */
            width: calc(100% - var(--left-toolbar-width));
            height: var(--toolbar-height);
            background-color: #FFFFFF;
            border-bottom: 1px solid #DADCE0;
            padding: 0 10px; /* Reduzido o padding */
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        /* --- Barras de Ferramentas Secundárias (Contexto) --- */
        .secondary-toolbar {
            position: fixed;
            top: var(--toolbar-height); /* Posicionada abaixo da principal */
            /* MODIFICADO: left: 0; -> left: var(--left-toolbar-width); */
            left: var(--left-toolbar-width);
            /* MODIFICADO: width: 100%; -> width: calc(100% - var(--left-toolbar-width)); */
            width: calc(100% - var(--left-toolbar-width));
            height: var(--secondary-toolbar-height);
            background-color: #f8f9fa;
            border-bottom: 1px solid #DADCE0;
            padding: 0 20px;
            box-sizing: border-box;
            display: none; /* Oculta por padrão */
            justify-content: flex-start;
            align-items: center;
            z-index: 99;
            gap: 15px;
            overflow-x: auto; /* Permite rolagem se não couber */
        }
        
        /* Mostra a barra quando o JS define display: flex */
        #text-toolbar-options[style*="display: flex"],
        #style-toolbar-options[style*="display: flex"],
        #drawing-toolbar-options[style*="display: flex"] {
            display: flex !important;
        }


        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 10px; /* Reduzido o gap */
        }

        .button-group {
            display: flex;
            align-items: center;
            gap: 5px; /* Reduzido o gap */
        }


        #toolbar .label, .secondary-toolbar .label {
            font-size: 0.9em;
            color: #5f6368;
            margin-right: 5px;
            white-space: nowrap;
        }

        /* Estilo comum para botões e selects (BARRAS SUPERIORES) */
        #toolbar button,
        #toolbar select,
        .secondary-toolbar button,
        .secondary-toolbar select,
        .secondary-toolbar input[type="number"] {
            background-color: #f8f9fa;
            border: 1px solid #DADCE0;
            color: #3c4043;
            padding: 8px 10px; /* Padding ajustado */
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            transition: background-color 0.2s, box-shadow 0.2s;
            height: 36px;
            box-sizing: border-box;
            white-space: nowrap;
        }
        
        /* Inputs numéricos na barra principal */
        #toolbar input[type="number"].toolbar-input-number {
            width: 60px; /* Mais curto */
            background-color: #f8f9fa;
            border: 1px solid #DADCE0;
            color: #3c4043;
            padding: 8px 5px; /* Menos padding lateral */
            border-radius: 4px;
            font-size: 0.9em;
            height: 36px;
            box-sizing: border-box;
            -moz-appearance: textfield; /* Remove setas no Firefox */
        }
        #toolbar input[type="number"].toolbar-input-number::-webkit-outer-spin-button,
        #toolbar input[type="number"].toolbar-input-number::-webkit-inner-spin-button {
            -webkit-appearance: none; /* Remove setas no Chrome/Safari */
            margin: 0;
        }


        /* Botões de ícone (Negrito, Itálico, etc.) */
        .secondary-toolbar button,
        #toolbar button.icon-only {
             padding: 8px;
             min-width: 36px;
             justify-content: center;
        }
        
        /* Input de número */
        .secondary-toolbar input[type="number"] {
            width: 70px;
            padding-right: 5px;
        }
        
        /* Input de Cor */
        .color-input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 36px;
            height: 36px;
            padding: 0;
            border: 1px solid #DADCE0;
            border-radius: 4px;
            background-color: transparent;
            cursor: pointer;
            overflow: hidden;
        }
        .color-input::-webkit-color-swatch-wrapper { padding: 2px; border: none; }
        .color-input::-webkit-color-swatch { border: 1px solid #bdbdbd; border-radius: 2px; }
        .color-input::-moz-color-swatch { border: 1px solid #bdbdbd; border-radius: 2px; }


        #toolbar select, .secondary-toolbar select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%2D%2Dxmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%2D%2Dwidth%3D%22292.4%22%2D%2Dheight%3D%22292.4%22%3E%3Cpath%2D%2Dfill%3D%22%235f6368%22%2D%2Dd%3D%22M287%2D%2D69.4a17.6%2D%2D17.6%2D%2D0%2D%2D0%2D%2D0-13-5.4H18.4c-5%2D%2D0-9.3%2D%2D1.8-12.9%2D%2D5.4A17.6%2D%2D17.6%2D%2D0%2D%2D0%2D%2D0%2D%2D0%2D%2D82.2c0%2D%2D5%2D%2D1.8%2D%2D9.3%2D%2D5.4%2D%2D12.9l128%2D%2D127.9c3.6%2D%2D3.6%2D%2D7.8%2D%2D5.4%2D%2D12.8%2D%2D5.4s9.2-1.8%2D%2D12.8-5.4L287%2D%2D95c3.5-3.5%2D%2D5.4-7.8%2D%2D5.4-12.8%2D%2D0-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 8px 10px;
            padding-right: 30px;
        }

        /* Efeitos de Hover e Active (BARRAS SUPERIORES) */
        #toolbar button:hover,
        #toolbar select:hover,
        .secondary-toolbar button:hover,
        .secondary-toolbar select:hover,
        .secondary-toolbar input:hover,
        #toolbar input[type="number"].toolbar-input-number:hover {
            background-color: #f1f3f4;
            border-color: #c6cacf;
        }

        #toolbar button:active,
        .secondary-toolbar button:active {
            background-color: #e8eaed;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        
        /* Estilo para botão de texto ATIVO (Negrito, Itálico, etc.) */
        .secondary-toolbar button.active {
             background-color: #e8eaed;
             box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
             border-color: #1a73e8;
        }
        .secondary-toolbar button.active .material-icons {
            color: #1a73e8;
        }


        #toolbar .material-icons,
        .secondary-toolbar .material-icons {
            font-size: 18px;
            color: #5f6368;
            vertical-align: middle;
        }

        /* --- Página de Impressão e Etiquetas --- */
        #pagina-de-impressao {
            max-width: var(--label-width);
            margin: 30px auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            transition: max-width 0.3s ease-in-out;
        }
        #pagina-de-impressao:not(.layout-dupla) .etiqueta-editavel {
            margin-bottom: 10px;
        }
        #pagina-de-impressao.layout-dupla {
            max-width: var(--print-page-width);
            justify-content: flex-start;
            gap: 10px 0;
        }
        #pagina-de-impressao.layout-dupla .etiqueta-editavel {
            margin-right: var(--label-gap);
            margin-bottom: 0;
        }
        /* Esta regra será sobreposta por JS dinâmico */
        #pagina-de-impressao.layout-dupla .etiqueta-editavel:nth-child(2n) {
            margin-right: 0;
        }

        .etiqueta-editavel {
            width: var(--label-width);
            height: var(--label-height);
            background-color: #FFFFFF;
            border: 1px solid #DADCE0;
            position: relative; /* Necessário para posicionar itens internos E O CANVAS */
            overflow: hidden;
            cursor: default;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: border-color 0.2s, box-shadow 0.2s, width 0.3s ease-in-out, height 0.3s ease-in-out;
            page-break-inside: avoid;
            page-break-after: auto;
            flex-shrink: 0;
            box-sizing: border-box;
        }
        .etiqueta-editavel.active {
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.3);
        }
        
        /* Overlay de Desenho */
        #draw-canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 50; /* Acima dos itens, abaixo da UI */
            cursor: crosshair;
            /* O JS definirá width e height */
        }
        
        /* Botão para concluir desenho */
        #btn-concluir-desenho {
            position: fixed;
            top: calc(var(--toolbar-height) + var(--secondary-toolbar-height) + 20px);
            /* MODIFICADO: Posição central agora considera a barra esquerda */
            left: calc( (100% - var(--left-toolbar-width)) / 2 + var(--left-toolbar-width) );
            transform: translateX(-50%);
            z-index: 101; /* Acima de tudo */
            background-color: #1a73e8;
            color: white;
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 20px;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: pointer;
        }


        /* --- Itens Arrastáveis e Redimensionáveis --- */
        .item-arrastavel {
            position: absolute;
            min-width: 20px;
            min-height: 20px;
            border: 1px dashed transparent;
            box-sizing: border-box;
            cursor: grab;
            touch-action: none;
            user-select: none;
            /* Important: Ensures transform origin is center for rotation */
            transform-origin: center center;
        }
        .item-arrastavel:hover { border-color: #1a73e8; }
        .item-arrastavel.selecionado-para-remocao {
            outline: 2px solid red;
            z-index: 11;
        }
        .item-arrastavel.interactjs-dragging,
        .item-arrastavel.interactjs-resizing {
            border-color: #1a73e8;
            border-style: solid;
            opacity: 0.8;
            z-index: 10;
        }
        
        /* --- Alça de Rotação --- */
        .rotate-handle {
            position: absolute;
            top: -6px; /* Ajustado para o novo tamanho */
            right: -6px; /* Ajustado para o novo tamanho */
            width: 12px; /* Drasticamente menor */
            height: 12px; /* Drasticamente menor */
            background-color: #fff;
            border: 1px solid #1a73e8; /* Borda mais fina */
            border-radius: 50%;
            cursor: grab;
            display: none;
            z-index: 12;
            box-shadow: 0 0 4px rgba(0,0,0,0.2);
        }
        .item-arrastavel.selecionado-para-remocao .rotate-handle {
            display: block; /* Mostra quando o item está selecionado */
        }
        .rotate-handle:active {
            cursor: grabbing;
            background-color: #e8eaed;
        }

        /* --- Tipos de Itens Específicos --- */
        .item-texto {
            border: 1px dashed #cccccc;
            padding: 2px;
            overflow: hidden;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.2;
            cursor: text;
            user-select: text;
        }
        .item-texto:focus {
             outline: 1px solid #1a73e8;
             border-style: solid;
             cursor: text;
        }
        
        /* Símbolo é tratado como texto, mas com tamanho inicial */
        .item-simbolo {
            font-size: 28px; /* Tamanho inicial do símbolo */
            line-height: 1;
        }

        .item-imagem img {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain;
        }
        
        /* Item Linha (Container) - CORREÇÃO */
        .item-linha {
            /* O container é transparente e apenas para interação */
            border: 1px dashed transparent; /* Borda de interação padrão */
            min-height: 20px; /* Área de toque mínima */
            height: auto; /* Altura se ajusta ao padding */
            display: flex;
            align-items: center; /* Centraliza a linha visual */
            padding: 5px 0; /* Padding vertical para facilitar o clique */
            box-sizing: border-box;
        }
        /* A linha visual interna */
        .linha-visual {
            width: 100%;
            /* JS controla altura, cor de fundo, borda, etc. */
        }
        /* Borda de redimensionamento da linha não deve ser sólida */
        .item-linha.interactjs-resizing {
            border-style: dashed;
            border-color: #1a73e8;
        }

        
        /* Item Forma (CSS) */
        .item-forma {
            background-color: #e0e0e0; /* Cor padrão */
            border: 1px solid #bdbdbd;
        }
        .shape-circulo { border-radius: 50%; }
        .shape-oval { border-radius: 50%; }
        .shape-triangulo { clip-path: polygon(50% 0%, 0% 100%, 100% 100%); }
        .shape-triangulo-inv { clip-path: polygon(50% 100%, 0% 0%, 100% 0%); }
        .shape-losango { clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); }
        .shape-estrela { clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
        .shape-coracao { clip-path: polygon(50% 25%, 20% 0, 0 20%, 0 50%, 50% 90%, 100% 50%, 100% 20%, 80% 0); }
        .shape-seta-dir { clip-path: polygon(0% 20%, 60% 20%, 60% 0%, 100% 50%, 60% 100%, 60% 80%, 0% 80%); }
        .shape-seta-esq { clip-path: polygon(100% 20%, 40% 20%, 40% 0%, 0% 50%, 40% 100%, 40% 80%, 100% 80%); }
        
        /* QR Code e Cód. Barras */
        .item-qrcode, .item-barcode {
            padding: 5px;
            background-color: white;
        }
        /* Garante que o conteúdo (svg/canvas) redimensione */
        .item-qrcode > div,
        .item-barcode > svg {
            width: 100% !important;
            height: 100% !important;
            box-sizing: border-box;
        }
        .item-barcode > svg {
            object-fit: fill;
        }
        .item-qrcode img, .item-qrcode canvas {
             width: 100% !important;
             height: 100% !important;
             object-fit: contain;
        }
        

        
        /* --- Modais --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            font-family: inherit;
        }
        .modal-content h3 {
            margin-top: 0;
            text-align: center;
            color: #333;
        }
        
        /* Modal de Símbolos */
        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 10px;
            max-width: 500px;
        }
        .modal-grid span {
            font-size: 28px;
            text-align: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .modal-grid span:hover {
            background-color: #f1f3f4;
        }
        .modal-close {
             background-color: #f1f3f4; color: #3c4043; border: 1px solid #dadce0;
             padding: 10px 20px; border-radius: 5px; cursor: pointer;
             font-size: 1em; transition: background-color 0.2s;
             display: block;
             margin: 20px auto 0;
        }
        .modal-close:hover { background-color: #e8eaed; }
        
        /* Modal de Input (QR/Barcode) & Duplicate Count */
        .modal-input-content {
             padding: 15px;
             text-align: center;
        }
        .modal-input-content input[type="text"],
        .modal-input-content input[type="number"] { /* Added number type */
            width: 90%;
            padding: 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 15px;
            box-sizing: border-box; /* Include padding in width */
        }
        .modal-input-content .button-group {
             justify-content: center;
             gap: 10px;
        }
         .modal-input-content .button-group button {
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
            border: none;
         }
         .modal-input-content .btn-submit {
             background-color: #1a73e8; color: white;
         }
         .modal-input-content .btn-submit:hover { background-color: #185abc; }
         .modal-input-content .btn-cancel {
             background-color: #f1f3f4; color: #3c4043; border: 1px solid #dadce0;
         }
         .modal-input-content .btn-cancel:hover { background-color: #e8eaed; }


        /* --- Estilos de Impressão --- */
        #print-style-dynamic { display: none; }
        
        /* ########## INÍCIO DA CORREÇÃO DE IMPRESSÃO ########## */
        /* Bloco de impressão REESCRITO para funcionar com o novo layout */
        @media print {
            body {
                background-color: #FFFFFF !important;
                padding: 0 !important;
                margin: 0 !important;
                width: var(--print-page-width) !important;
                display: block !important; /* Remove o flex do print */
            }

            /* Esconde toda a UI (Barras, modais, alças, etc) */
            #toolbar, 
            .secondary-toolbar, 
            .modal-overlay, 
            #btn-concluir-desenho, 
            .rotate-handle,
            #left-toolbar { /* Esconde a nova barra da esquerda */
                display: none !important;
            }
            
            /* * CORREÇÃO: 
             * NÃO esconda o wrapper, apenas RESSETE o layout dele
             * para que ele não tenha margens ou paddings da UI.
             */
            #main-content-wrapper {
                 display: block !important;
                 margin: 0 !important;
                 padding: 0 !important;
                 width: auto !important;
                 position: static !important;
            }

            /* #pagina-de-impressao agora funciona, pois seu pai não está mais escondido */
            #pagina-de-impressao {
                margin: 0 !important;
                padding: 0 !important;
                max-width: none !important;
                gap: 0 !important;
                display: flex !important;
                flex-wrap: wrap !important;
                justify-content: flex-start !important;
                width: var(--print-page-width) !important;
            }

            /* Regras de layout de impressão (margem/quebra) são movidas para #print-style-dynamic */

            .etiqueta-editavel {
                border: none !important;
                box-shadow: none !important;
                /* margin-bottom: 0 !important; */ /* Controlado por JS */
                display: inline-block !important; /* Chave para alinhamento */
                vertical-align: top !important;
                page-break-inside: avoid !important;
            }

            .item-arrastavel {
                border-color: transparent !important;
                outline: none !important;
            }
            
            /* Garante que a linha (borda) seja impressa */
            .item-linha .linha-visual {
                background-color: transparent !important; /* Esconde o fundo */
                border-top-color: var(--line-print-color, #000) !important; /* Usa a cor definida */
                border-top-style: var(--line-print-style, solid) !important;
                /* Cor de fundo sólida será impressa normally */
                background-color: var(--line-print-style, solid) == 'solid' ? var(--line-print-color, #000) : transparent !important;
            }
            
            /* Ajustes QR/Barcode para impressão */
            .item-qrcode, .item-barcode {
                padding: 0 !important;
            }
            .item-barcode > svg {
                /* O JS do JsBarcode pode ser teimoso, mas tentamos */
                max-width: 100% !important;
                max-height: 100% !important;
            }
        }
        /* ########## FIM DA CORREÇÃO DE IMPRESSÃO ########## */


    </style>
    
    <style id="screen-style-dynamic"></style>
    
</head>
<body>

    <div id="left-toolbar">
        <div class="button-group">
            <button id="btn-add-texto" title="Adicionar caixa de texto">
                <span class="material-icons">title</span>
            </button>
            <button id="btn-add-imagem" title="Adicionar imagem">
                <span class="material-icons">image</span>
            </button>
            
            <div class="select-wrapper">
                <span class="material-icons select-icon">category</span>
                <select id="select-add-shape" title="Adicionar forma">
                    <option value="" disabled selected></option>
                    <option value="quadrado">■ Quadrado</option>
                    <option value="circulo">● Círculo</option>
                    <option value="oval">○ Oval</option>
                    <option value="triangulo">▲ Triângulo</option>
                    <option value="triangulo-inv">▼ Triângulo Inv.</option>
                    <option value="losango">◆ Losango</option>
                    <option value="estrela">★ Estrela</option>
                    <option value="coracao">♥ Coração</option>
                    <option value="seta-dir">► Seta (Dir)</option>
                    <option value="seta-esq">◄ Seta (Esq)</option>
                </select>
            </div>
            
            <button id="btn-add-linha" title="Adicionar linha">
                <span class="material-icons">horizontal_rule</span>
            </button>
            <button id="btn-add-simbolo" title="Adicionar símbolo">
                <span class="material-icons">emoji_emotions</span>
            </button>
            <button id="btn-add-qrcode" title="Adicionar QR Code">
                <span class="material-icons">qr_code_2</span>
            </button>
            <button id="btn-add-barcode" title="Adicionar Código de Barras">
                <span class="material-icons">view_week</span>
            </button>
            <button id="btn-add-lapis" title="Desenhar (Lápis)">
                <span class="material-icons">draw</span>
            </button>
            <button id="btn-remover-item" title="Remover item selecionado" style="color: #D93025;">
                <span class="material-icons">delete</span>
            </button>
        </div>
    </div>

    <div id="main-content-wrapper">

        <div id="toolbar">
            <div class="toolbar-section">
                <div class="button-group">
                    <button id="btn-add-etiqueta" title="Adicionar nova etiqueta à página" class="icon-only">
                        <span class="material-icons">add_to_queue</span>
                    </button>
                    <button id="btn-duplicar-etiqueta" title="Copiar etiqueta selecionada" class="icon-only">
                        <span class="material-icons">content_copy</span>
                    </button>
                    <button id="btn-remover-etiqueta" title="Remover etiqueta selecionada" class="icon-only" style="color: #D93025;">
                        <span class="material-icons">delete_sweep</span>
                    </button>
                    <button id="btn-imprimir" title="Imprimir página" class="icon-only">
                        <span class="material-icons">print</span>
                    </button>
                    <button id="btn-salvar" title="Salvar etiqueta" class="icon-only">
                        <span class="material-icons">save</span>
                    </button>
                    <button id="btn-abrir" title="Abrir etiqueta" class="icon-only">
                        <span class="material-icons">folder_open</span>
                    </button>
                </div>
                <div class="button-group">
                    <button id="btn-zoom-out" title="Diminuir Zoom">
                        <span class="material-icons">zoom_out</span>
                    </button>
                    <button id="btn-zoom-in" title="Aumentar Zoom">
                        <span class="material-icons">zoom_in</span>
                    </button>
                    <button id="btn-zoom-reset" title="Restaurar Zoom">
                        <span class="material-icons">zoom_in_map</span>
                    </button>
                </div>
                <div class="button-group">
                    <span class="label">Selecionar Etiqueta:</span>
                    <select id="select-layout-preset" title="Selecionar tamanho e layout da etiqueta">
                        <option value="100x50">100 x 50 mm (1 Col)</option>
                        <option value="50x25">50 x 25 mm (1 Col)</option>
                        <option value="50x25-dupla">50 x 25 mm (2 Col)</option>
                        <option value="personalizado" selected>Personalizado</option>
                    </select>
                </div>
                <div id="custom-layout-inputs" class="button-group" style="display: none;">
                    <span class="label">Larg. (mm):</span>
                    <input type="number" id="input-custom-width" value="100" class="toolbar-input-number">
                    <span class="label">Alt. (mm):</span>
                    <input type="number" id="input-custom-height" value="50" class="toolbar-input-number">
                    <span class="label">Colunas:</span>
                    <input type="number" id="input-custom-cols" value="1" min="1" max="10" class="toolbar-input-number" style="width: 45px;">
                </div>
            </div>
            
            <div class="toolbar-section" style="overflow-x: auto; max-width: 50%;"> 
                </div>

            <input type="file" id="input-imagem" accept="image/*" style="display: none;">
            <input type="file" id="input-abrir-etiqueta" accept=".json,application/json" style="display: none;">
        </div>
        
        <div id="text-toolbar-options" class="secondary-toolbar">
            <div class="button-group">
                <select id="select-font-family" title="Tipo de Fonte">
                    <option value="Arial, sans-serif">Arial</option>
                    <option value="'Times New Roman', Times, serif">Times New Roman</option>
                    <option value="'Courier New', Courier, monospace">Courier New</option>
                    <option value="Verdana, Geneva, sans-serif">Verdana</option>
                    <option value="Georgia, serif">Georgia</option>
                </select>
                <input type="number" id="input-font-size" min="6" max="150" value="10" title="Tamanho da Fonte (px)">
                <input type="color" id="input-font-color" class="color-input" value="#000000" title="Cor da Fonte">
            </div>
            <div class="button-group">
                <button id="btn-text-bold" title="Negrito"><span class="material-icons">format_bold</span></button>
                <button id="btn-text-italic" title="Itálico"><span class="material-icons">format_italic</span></button>
                <button id="btn-text-underline" title="Sublinhado"><span class="material-icons">format_underlined</span></button>
                <button id="btn-text-strike" title="Tachado"><span class="material-icons">strikethrough_s</span></button>
            </div>
            <div class="button-group">
                <select id="select-text-transform" title="Transformação do Texto">
                    <option value="none">Normal</option>
                    <option value="uppercase">MAIÚSCULAS</option>
                    <option value="lowercase">minúsculas</option>
                    <option value="capitalize">Capitalizadas</option>
                </select>
            </div>
        </div>
        
        <div id="style-toolbar-options" class="secondary-toolbar">
            <div class="button-group">
                <span class="label">Cor:</span>
                <input type="color" id="input-style-color" class="color-input" value="#000000" title="Cor da Linha/Forma">
            </div>
            <div class="button-group">
                <span class="label">Espessura (px):</span>
                <input type="number" id="input-style-thickness" min="1" max="50" value="2" title="Espessura da Linha/Borda">
            </div>
            <div class="button-group">
                <span class="label">Estilo:</span>
                <select id="select-style-type" title="Estilo da Linha/Borda">
                    <option value="solid">Sólida</option>
                    <option value="dashed">Tracejada</option>
                    <option value="dotted">Pontilhada</option>
                </select>
            </div>
        </div>
        
        <div id="drawing-toolbar-options" class="secondary-toolbar">
             <div class="button-group">
                <button id="btn-draw-tool-pencil" class="active" title="Lápis">
                    <span class="material-icons">edit</span>
                </button>
                <button id="btn-draw-tool-eraser" title="Borracha">
                    <span class="material-icons">cleaning_services</span>
                </button>
             </div>
             <div class="button-group">
                <span class="label">Cor:</span>
                <input type="color" id="input-draw-color" class="color-input" value="#000000" title="Cor do Lápis">
            </div>
            <div class="button-group">
                <span class="label">Espessura (px):</span>
                <input type="number" id="input-draw-thickness" min="1" max="50" value="2" title="Espessura do Lápis/Borracha">
            </div>
        </div>


        <div id="pagina-de-impressao">
            <div class="etiqueta-editavel active" data-label-id="label-1">
                </div>
        </div>
    
    </div> <div id="modal-simbolos" class="modal-overlay">
        <div class="modal-content">
            <h3>Escolha um Símbolo</h3>
            <div class="modal-grid" id="symbol-grid-container">
                </div>
            <button id="modal-simbolos-close" class="modal-close">Fechar</button>
        </div>
    </div>
    
    <div id="modal-input" class="modal-overlay">
        <div class="modal-content modal-input-content">
            <h3 id="modal-input-title">Digite o valor</h3>
            <input type="text" id="modal-input-field">
            <div class="button-group">
                <button id="modal-input-submit" class="btn-submit">Gerar</button>
                <button id="modal-input-close" class="btn-cancel">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modal-duplicate-count" class="modal-overlay">
        <div class="modal-content modal-input-content">
            <h3 id="modal-duplicate-title">Quantas cópias deseja criar?</h3>
            <input type="number" id="modal-duplicate-field" value="1" min="1" max="100">
            <div class="button-group">
                <button id="modal-duplicate-submit" class="btn-submit">Criar</button>
                <button id="modal-duplicate-close" class="btn-cancel">Cancelar</button>
            </div>
        </div>
    </div>
    
    <style id="print-style-dynamic"></style>
    <script>
        
        // --- Referências DOM (Principais) ---
        const paginaDeImpressao = document.getElementById('pagina-de-impressao');
        const toolbar = document.getElementById('toolbar');
        const btnAddEtiqueta = document.getElementById('btn-add-etiqueta');
        const btnImprimir = document.getElementById('btn-imprimir');
        const btnSalvar = document.getElementById('btn-salvar');
        const btnAbrir = document.getElementById('btn-abrir');
        const btnAddTexto = document.getElementById('btn-add-texto');
        const btnAddImagem = document.getElementById('btn-add-imagem');
        const btnRemoverItem = document.getElementById('btn-remover-item');
        const inputImagem = document.getElementById('input-imagem');
        const inputAbrirEtiqueta = document.getElementById('input-abrir-etiqueta');
        const printStyleDynamic = document.getElementById('print-style-dynamic');
        const screenStyleDynamic = document.getElementById('screen-style-dynamic');

        // --- Referências DOM (Layout e Duplicar) ---
        const selectLayoutPreset = document.getElementById('select-layout-preset');
        const customLayoutInputs = document.getElementById('custom-layout-inputs');
        const btnDuplicarEtiqueta = document.getElementById('btn-duplicar-etiqueta');
        const btnRemoverEtiqueta = document.getElementById('btn-remover-etiqueta'); // NOVO
        const btnZoomIn = document.getElementById('btn-zoom-in');
        const btnZoomOut = document.getElementById('btn-zoom-out');
        const btnZoomReset = document.getElementById('btn-zoom-reset');
        const inputCustomWidth = document.getElementById('input-custom-width');
        const inputCustomHeight = document.getElementById('input-custom-height');
        const inputCustomCols = document.getElementById('input-custom-cols');

        // --- Referências DOM (Novas Ferramentas - Agora na Barra Esquerda) ---
        const selectAddShape = document.getElementById('select-add-shape');
        const btnAddLinha = document.getElementById('btn-add-linha');
        const btnAddSimbolo = document.getElementById('btn-add-simbolo');
        const btnAddLapis = document.getElementById('btn-add-lapis');
        const btnAddQRCode = document.getElementById('btn-add-qrcode');
        const btnAddBarcode = document.getElementById('btn-add-barcode');

        // --- Referências DOM (Modais) ---
        const modalSimbolos = document.getElementById('modal-simbolos');
        const symbolGridContainer = document.getElementById('symbol-grid-container');
        const modalSimbolosClose = document.getElementById('modal-simbolos-close');
        const modalInput = document.getElementById('modal-input');
        const modalInputTitle = document.getElementById('modal-input-title');
        const modalInputField = document.getElementById('modal-input-field');
        const modalInputSubmit = document.getElementById('modal-input-submit');
        const modalInputClose = document.getElementById('modal-input-close');
        
        // Modal de Duplicação
        const modalDuplicateCount = document.getElementById('modal-duplicate-count');
        const modalDuplicateField = document.getElementById('modal-duplicate-field');
        const modalDuplicateSubmit = document.getElementById('modal-duplicate-submit');
        const modalDuplicateClose = document.getElementById('modal-duplicate-close');


        // --- Referências DOM (Barras Secundárias) ---
        const textToolbarOptions = document.getElementById('text-toolbar-options');
        const selectFontFamily = document.getElementById('select-font-family');
        const inputFontSize = document.getElementById('input-font-size');
        const inputFontColor = document.getElementById('input-font-color');
        const btnTextBold = document.getElementById('btn-text-bold');
        const btnTextItalic = document.getElementById('btn-text-italic');
        const btnTextUnderline = document.getElementById('btn-text-underline');
        const btnTextStrike = document.getElementById('btn-text-strike');
        const selectTextTransform = document.getElementById('select-text-transform');
        
        const styleToolbarOptions = document.getElementById('style-toolbar-options');
        const inputStyleColor = document.getElementById('input-style-color');
        const inputStyleThickness = document.getElementById('input-style-thickness');
        const selectStyleType = document.getElementById('select-style-type');
        
        const drawingToolbarOptions = document.getElementById('drawing-toolbar-options');
        const btnDrawToolPencil = document.getElementById('btn-draw-tool-pencil');
        const btnDrawToolEraser = document.getElementById('btn-draw-tool-eraser');
        const inputDrawColor = document.getElementById('input-draw-color');
        const inputDrawThickness = document.getElementById('input-draw-thickness');

        // --- Variáveis de Estado ---
        let etiquetaAtiva = document.querySelector('.etiqueta-editavel.active');
        let itemSelecionado = null;
        let labelCounter = 1;
        let itemCounter = 0;
        let tamanhoAtualEtiqueta = { width: '100mm', height: '50mm' };
        let layoutAtual = 'simples';
        let modalInputCallback = null; // Callback para o modal de input genérico
        let zoomLevel = 1.0;
        
        // --- Estado de Desenho (Lápis) ---
        let isDrawing = false;
        let drawCanvas = null;
        let drawCtx = null;
        let btnConcluirDesenho = null;
        // Variáveis para armazenar os listeners de desenho (para remoção correta)
        let drawListeners = { start: null, end: null, draw: null };


        // --- Funções Auxiliares (Definir Ativa, IDs, Seleção) ---

        function definirEtiquetaAtiva(etiqueta) {
            if (isDrawing) pararModoDesenho(false); // Cancela desenho ao trocar
            if (etiquetaAtiva) {
                etiquetaAtiva.classList.remove('active');
            }
            etiquetaAtiva = etiqueta;
            if (etiquetaAtiva) {
                etiquetaAtiva.classList.add('active');
            }
            desselecionarItem();
        }

        function gerarItemId() { return `item-${++itemCounter}`; }
        function gerarLabelId() { return `label-${++labelCounter}`; }

        function selecionarItem(itemElement) {
            desselecionarItem(); // Desseleciona anterior
            itemSelecionado = itemElement;
            
            if (itemSelecionado) {
                itemSelecionado.classList.add('selecionado-para-remocao'); 
                btnRemoverItem.style.display = 'inline-flex';

                // Lógica da barra de ferramentas de CONTEXTO
                if (itemSelecionado.classList.contains('item-texto') || itemSelecionado.classList.contains('item-simbolo')) {
                    textToolbarOptions.style.display = 'flex';
                    updateTextToolState();
                } else if (itemSelecionado.classList.contains('item-linha') || itemSelecionado.classList.contains('item-forma')) {
                    styleToolbarOptions.style.display = 'flex';
                    updateStyleToolState();
                } else {
                    // Esconde todas as barras de contexto
                    textToolbarOptions.style.display = 'none';
                    styleToolbarOptions.style.display = 'none';
                    drawingToolbarOptions.style.display = 'none';
                }
            }
        }

        function desselecionarItem() {
            if (itemSelecionado) {
                itemSelecionado.classList.remove('selecionado-para-remocao');
            }
            itemSelecionado = null;
            btnRemoverItem.style.display = 'none';
            textToolbarOptions.style.display = 'none';
            styleToolbarOptions.style.display = 'none';
            drawingToolbarOptions.style.display = 'none';
        }
        
        function rgbToHex(rgb) {
            if (!rgb || !rgb.startsWith('rgb')) return rgb;
            let match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (!match) return '#000000';
            function hex(c) { return ('0' + parseInt(c).toString(16)).slice(-2); }
            return '#' + hex(match[1]) + hex(match[2]) + hex(match[3]);
        }


        // --- Funções de Gerenciamento de Layout e Tamanho ---
        function aplicarLayout(width_mm, height_mm, colunas) {
            const width = `${width_mm}mm`;
            const height = `${height_mm}mm`;
            
            layoutAtual = (colunas > 1) ? 'multipla' : 'simples';
            tamanhoAtualEtiqueta = { width, height };
            
            const rootStyle = document.documentElement.style;
            rootStyle.setProperty('--label-width', width);
            rootStyle.setProperty('--label-height', height);

            // Calcular largura da página de impressão
            let printWidth;
            if (colunas === 1) {
                printWidth = width;
                paginaDeImpressao.classList.remove('layout-dupla'); // Usa 'layout-dupla' para lógica de gap
            } else {
                printWidth = `calc(${colunas} * ${width} + (${colunas - 1}) * var(--label-gap))`;
                paginaDeImpressao.classList.add('layout-dupla'); 
            }
            
            rootStyle.setProperty('--print-page-width', printWidth);
            rootStyle.setProperty('--print-page-height', height);
            paginaDeImpressao.style.maxWidth = printWidth;

            // Atualiza o estilo de impressão dinâmico
            printStyleDynamic.innerHTML = `
                @media print { 
                    @page { 
                        size: ${printWidth} ${height}; 
                        margin: 0; 
                    }
                    
                    /* Lógica de margem e quebra de página */
                    .etiqueta-editavel {
                        margin-right: var(--label-gap) !important;
                    }
                    /* Remove margem do último item da linha */
                    .etiqueta-editavel:nth-child(${colunas}n) {
                        margin-right: 0 !important;
                    }
                    /* Força quebra APÓS a linha, mas não no último item */
                    .etiqueta-editavel:nth-child(${colunas}n):not(:last-child) {
                         page-break-after: always !important;
                    }
                    /* Evita quebras desnecessárias no final */
                    .etiqueta-editavel:last-child,
                    .etiqueta-editavel:nth-child(${colunas}n):last-child {
                        page-break-after: avoid !important;
                    }
                }
            `;
            
            // Atualiza estilo de tela dinâmico (para gaps corretos)
            if (colunas > 1) {
                 screenStyleDynamic.innerHTML = `
                    #pagina-de-impressao.layout-dupla .etiqueta-editavel:nth-child(${colunas}n) {
                         margin-right: 0;
                    }
                 `;
            } else {
                 screenStyleDynamic.innerHTML = ''; // Limpa se for coluna única
            }

            // Atualiza o select de preset para "personalizado" se os valores não baterem
            if ( (width_mm == 100 && height_mm == 50 && colunas == 1) ) {
                selectLayoutPreset.value = '100x50';
            } else if ( (width_mm == 50 && height_mm == 25 && colunas == 1) ) {
                selectLayoutPreset.value = '50x25';
            } else if ( (width_mm == 50 && height_mm == 25 && colunas == 2) ) {
                selectLayoutPreset.value = '50x25-dupla';
            } else {
                selectLayoutPreset.value = 'personalizado';
            }
        }
        
        function definirLayoutETamanho(layoutValue) {
            let width_mm, height_mm, colunas;

            if (layoutValue === 'personalizado') {
                customLayoutInputs.style.display = 'flex';
                handleCustomLayoutChange(); // Aplica os valores atuais
                return;
            }

            customLayoutInputs.style.display = 'none';
            
            if (layoutValue === '100x50') {
                width_mm = 100; height_mm = 50; colunas = 1;
            } else if (layoutValue === '50x25') {
                width_mm = 50; height_mm = 25; colunas = 1;
            } else if (layoutValue === '50x25-dupla') {
                width_mm = 50; height_mm = 25; colunas = 2;
            } else {
                // Se for "personalizado" ou outro, não faz nada,
                // deixa o usuário digitar.
                return; 
            }

            // Atualiza os inputs
            inputCustomWidth.value = width_mm;
            inputCustomHeight.value = height_mm;
            inputCustomCols.value = colunas;

            // Aplica o layout
            aplicarLayout(width_mm, height_mm, colunas);
        }


        // --- Funções de Adição de Itens ---

        // Adiciona uma nova etiqueta
        function adicionarEtiqueta() {
            if (isDrawing) pararModoDesenho(false);
            const novaEtiqueta = document.createElement('div');
            novaEtiqueta.classList.add('etiqueta-editavel');
            novaEtiqueta.dataset.labelId = gerarLabelId();
            paginaDeImpressao.appendChild(novaEtiqueta);
            definirEtiquetaAtiva(novaEtiqueta);
        }

        // Função para duplicar a etiqueta ativa múltiplas vezes
        function duplicarEtiqueta(count = 1) { // Aceita contagem
            if (isDrawing) pararModoDesenho(false);
            if (!etiquetaAtiva) {
                alertPersonalizado("Por favor, selecione a etiqueta que deseja duplicar.");
                return;
            }

            let lastClone = etiquetaAtiva; // Referência para inserir após

            for (let i = 0; i < count; i++) {
                const clone = etiquetaAtiva.cloneNode(true);
                clone.classList.remove('active');
                clone.dataset.labelId = gerarLabelId();
                
                // Insere após a etiqueta ativa ou o último clone criado
                lastClone.insertAdjacentElement('afterend', clone);

                // IMPORTANTE: Reinicializa a interação para todos os itens clonados
                clone.querySelectorAll('.item-arrastavel').forEach(item => {
                    inicializarInteracao(item);
                });
                
                lastClone = clone; // Atualiza a referência para a próxima inserção
            }

            // Define o último clone criado como ativo
            definirEtiquetaAtiva(lastClone);
        }


        // Adiciona um item genérico (configura posição, tamanho e interação)
        function adicionarItem(etiqueta, tipo, conteudo = null) {
            if (!etiqueta) {
                alertPersonalizado("Selecione uma etiqueta primeiro!");
                return null;
            }
            if (isDrawing) pararModoDesenho(false); // Sai do modo desenho

            const item = document.createElement('div');
            item.classList.add('item-arrastavel', `item-${tipo}`);
            item.id = gerarItemId();
            
            // Posição e Tamanho Iniciais
            const etiquetaRect = etiqueta.getBoundingClientRect();
            const etiquetaWidth = etiquetaRect.width || parseFloat(tamanhoAtualEtiqueta.width) || 100;
            const etiquetaHeight = etiquetaRect.height || parseFloat(tamanhoAtualEtiqueta.height) || 50;

            const startX = Math.min(10, etiquetaWidth * 0.1);
            const startY = Math.min(10, etiquetaHeight * 0.1);
            let startWidth = Math.max(80, etiquetaWidth * 0.25);
            let startHeight = Math.max(50, etiquetaHeight * 0.25);

            item.style.left = `${startX}px`; // Apenas para posicionamento inicial do DOM
            item.style.top = `${startY}px`; // JS usará transform
            item.dataset.x = startX;
            item.dataset.y = startY;
            item.dataset.angle = 0; // Adiciona dado de ângulo
            item.style.transform = `translate(${startX}px, ${startY}px) rotate(0deg)`; // Adiciona rotação

            // Adiciona alça de rotação
            const rotateHandle = document.createElement('div');
            rotateHandle.className = 'rotate-handle';
            item.appendChild(rotateHandle);

            // Configuração por tipo
            if (tipo === 'texto' || tipo === 'simbolo') {
                item.contentEditable = 'true';
                item.textContent = conteudo || 'Edite aqui';
                item.style.height = 'auto';
                item.style.minHeight = '20px';
                item.style.width = `${startWidth}px`;
                item.style.fontSize = tipo === 'simbolo' ? '28px' : '10px';
                item.style.fontFamily = 'Arial, sans-serif';
                item.style.color = '#000000';
                if(tipo === 'simbolo') item.classList.add('item-simbolo');
            } else if (tipo === 'imagem' && conteudo) {
                const img = document.createElement('img');
                img.src = conteudo;
                img.draggable = false;
                item.appendChild(img);
                item.style.width = `${startWidth}px`;
                item.style.height = `${startHeight}px`;
            } else if (tipo === 'forma') {
                item.classList.add('shape-' + (conteudo || 'quadrado'));
                item.style.width = `${startWidth}px`;
                item.style.height = `${startHeight}px`;
                item.style.backgroundColor = '#d3d3d3'; // Padrão
            } else if (tipo === 'linha') {
                startWidth = Math.max(100, etiquetaWidth * 0.4);
                startHeight = 2; // Espessura inicial
                item.style.width = `${startWidth}px`;
                item.style.height = 'auto'; // Container da linha
                item.style.minHeight = '20px'; // Área de toque
                
                const linhaVisual = document.createElement('div');
                linhaVisual.className = 'linha-visual';
                linhaVisual.style.height = `${startHeight}px`;
                linhaVisual.style.backgroundColor = '#000000';
                item.appendChild(linhaVisual);
            } else if (tipo === 'qrcode') {
                startWidth = Math.max(80, etiquetaWidth * 0.2); // QR Codes são quadrados
                startHeight = startWidth;
                item.style.width = `${startWidth}px`;
                item.style.height = `${startHeight}px`;
                // O conteúdo (div) será adicionado por addQRCode
            } else if (tipo === 'barcode') {
                startHeight = Math.max(40, etiquetaHeight * 0.15); // Barcodes são largos
                item.style.width = `${startWidth}px`;
                item.style.height = `${startHeight}px`;
                 // O conteúdo (svg) será adicionado por addBarcode
            }

            etiqueta.appendChild(item);
            inicializarInteracao(item);
            addSelectionListeners(item); // Attach selection listeners
            
            // Seleciona o item recém-criado (exceto para QR/Barcode que são criados por funções específicas)
            if (tipo !== 'qrcode' && tipo !== 'barcode') {
                selecionarItem(item);
                if (tipo === 'texto') item.focus();
            }

            return item;
        }
        
        // --- Funções Específicas: QR Code e Barcode ---
        
        function addQRCode(data) {
            if (!etiquetaAtiva) return;
            const item = adicionarItem(etiquetaAtiva, 'qrcode');
            if (!item) return;
            item.dataset.value = data; // Store the original data
            
            const qrContainer = document.createElement('div');
            qrContainer.id = `qr-container-${item.id}`;
            item.appendChild(qrContainer);
            
            try {
                new QRCode(qrContainer, {
                    text: data,
                    width: 128, // Tamanho inicial, vai redimensionar
                    height: 128,
                    correctLevel : QRCode.CorrectLevel.H
                });
                // Ensure generated elements fit
                const qrElement = qrContainer.querySelector('canvas') || qrContainer.querySelector('img');
                if (qrElement) {
                    qrElement.style.width = '100%';
                    qrElement.style.height = '100%';
                    qrElement.style.objectFit = 'contain';
                }
            } catch(e) {
                console.error("Erro ao gerar QR Code:", e);
                alertPersonalizado("Erro ao gerar QR Code. Verifique os dados.");
                item.remove();
            }
            selecionarItem(item);
        }
        
        function addBarcode(data) {
             if (!etiquetaAtiva) return;
             const item = adicionarItem(etiquetaAtiva, 'barcode');
             if (!item) return;
             item.dataset.value = data; // Store the original data
             
             const barcodeSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
             barcodeSvg.id = `barcode-${item.id}`;
             item.appendChild(barcodeSvg);
             
             try {
                JsBarcode(barcodeSvg, data, {
                    format: "CODE128",
                    displayValue: true, // Show text below barcode
                    fontSize: 14,
                    width: 2, // Bar width
                    height: 40, // Bar height
                    margin: 5 // Margin around barcode
                });
                // Ensure SVG fits container
                barcodeSvg.style.width = '100%';
                barcodeSvg.style.height = '100%';
                barcodeSvg.style.objectFit = 'fill'; // Stretch to fill
             } catch (e) {
                 console.error("Erro ao gerar Código de Barras:", e);
                 alertPersonalizado("Valor inválido para Código de Barras (CODE128).");
                 item.remove();
             }
             selecionarItem(item);
        }

        // --- Lógica de Interação (Arrastar, Redimensionar E ROTACIONAR) ---

        function inicializarInteracao(elemento) {
            let position = { x: parseFloat(elemento.dataset.x) || 0, y: parseFloat(elemento.dataset.y) || 0 };
            let angle = parseFloat(elemento.dataset.angle) || 0;

            // Aplica transformação inicial
            elemento.style.transform = `translate(${position.x}px, ${position.y}px) rotate(${angle}deg)`;

            interact(elemento)
                .draggable({
                    listeners: {
                        start(event) {
                            selecionarItem(event.target);
                            event.target.style.cursor = 'grabbing';
                        },
                        move(event) {
                            position.x += event.dx;
                            position.y += event.dy;
                            // Update transform string preserving rotation
                            event.target.style.transform = `translate(${position.x}px, ${position.y}px) rotate(${angle}deg)`;
                        },
                        end(event) {
                            event.target.dataset.x = position.x;
                            event.target.dataset.y = position.y;
                            event.target.style.cursor = 'grab';
                        }
                    },
                    modifiers: [
                        interact.modifiers.restrictRect({ restriction: 'parent', endOnly: false })
                    ],
                    inertia: false
                })
                .resizable({
                    edges: { 
                        top: !elemento.classList.contains('item-linha'), // Linha NÃO redimensiona na vertical
                        left: true, 
                        bottom: !elemento.classList.contains('item-linha'), // Linha NÃO redimensiona na vertical
                        right: true 
                    },
                    listeners: {
                        start(event) {
                            selecionarItem(event.target);
                        },
                        move: function (event) {
                            // Update position based on resize delta, considering current angle
                            const dx = event.deltaRect.left;
                            const dy = event.deltaRect.top;
                            
                            // Adjust position based on rotation to keep top-left corner anchored during resize
                            const rad = angle * Math.PI / 180;
                            const cos = Math.cos(rad);
                            const sin = Math.sin(rad);
                            
                            // Transform the delta position according to the element's rotation
                            const rotatedDx = dx * cos - dy * sin;
                            const rotatedDy = dx * sin + dy * cos;

                            position.x += rotatedDx;
                            position.y += rotatedDy;

                            Object.assign(event.target.style, {
                                width: `${event.rect.width}px`,
                                height: `${event.rect.height}px`,
                                // Update transform string with new position and existing rotation
                                transform: `translate(${position.x}px, ${position.y}px) rotate(${angle}deg)`
                            });

                            // Update dataset position
                            event.target.dataset.x = position.x;
                            event.target.dataset.y = position.y;
                        }
                    },
                    modifiers: [
                        interact.modifiers.restrictRect({ restriction: 'parent' }),
                        interact.modifiers.restrictSize({ min: { width: 20, height: 1 } }) // Min height 1 for lines
                    ],
                })
                .on('tap', function (event) {
                    selecionarItem(event.target);
                    if (event.target.classList.contains('item-texto') || event.target.classList.contains('item-simbolo')) {
                         event.target.focus();
                    }
                    /* ########## CORREÇÃO DO BUG DE TEXTO ##########
                       A linha abaixo (que existia no seu original) impedia
                       o cursor de aparecer na caixa de texto. Eu a removi.
                       
                       event.preventDefault(); 
                       
                    ################################################# */
                });
            
            // --- Interação da Alça de Rotação ---
            const rotateHandle = elemento.querySelector('.rotate-handle');
            if (rotateHandle) {
                interact(rotateHandle).draggable({
                    onstart: function(event) {
                        event.target.style.cursor = 'grabbing';
                        const rect = elemento.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;
                        event.interaction.center = { x: centerX, y: centerY };
                    },
                    onmove: function (event) {
                        const { center } = event.interaction;
                        const angleRad = Math.atan2(event.pageY - (center.y + window.scrollY), event.pageX - (center.x + window.scrollX));
                        angle = angleRad * (180 / Math.PI);
                        elemento.style.transform = `translate(${position.x}px, ${position.y}px) rotate(${angle}deg)`;
                    },
                    onend: function (event) {
                        event.target.style.cursor = 'grab';
                        elemento.dataset.angle = angle; 
                    }
                });
            }
        }

        // --- Função Centralizada para Listeners de Seleção ---
        function addSelectionListeners(item) {
            item.addEventListener('click', (event) => {
                event.stopPropagation();
                selecionarItem(item);
            });

            // For text and symbol items, also select on focus
            if (item.classList.contains('item-texto') || item.classList.contains('item-simbolo')) {
                item.addEventListener('focus', (event) => {
                    event.stopPropagation();
                    selecionarItem(item);
                });
            }
        }
        
        // --- Funções da Barra de Ferramentas de Texto ---

        function updateTextToolState() {
            if (!itemSelecionado) return;
            const style = window.getComputedStyle(itemSelecionado);
            let fontFamily = style.fontFamily.split(',')[0].replace(/['"]/g, '').trim();
            let foundFont = Array.from(selectFontFamily.options).find(opt => opt.value.toLowerCase().includes(fontFamily.toLowerCase()));
            selectFontFamily.value = foundFont ? foundFont.value : 'Arial, sans-serif';
            inputFontSize.value = parseInt(style.fontSize) || 10;
            inputFontColor.value = rgbToHex(style.color);
            selectTextTransform.value = style.textTransform || 'none';
            btnTextBold.classList.toggle('active', style.fontWeight === 'bold' || parseInt(style.fontWeight) >= 700);
            btnTextItalic.classList.toggle('active', style.fontStyle === 'italic');
            const textDecor = style.textDecorationLine || '';
            btnTextUnderline.classList.toggle('active', textDecor.includes('underline'));
            btnTextStrike.classList.toggle('active', textDecor.includes('line-through'));
        }
        
        function toggleTextDecoration(style, button) {
            if (!itemSelecionado) return;
            let currentDecor = itemSelecionado.style.textDecorationLine || '';
            const hasStyle = currentDecor.includes(style);
            let newDecor = currentDecor.split(' ').filter(s => s.trim() !== '' && s !== style);
            if (!hasStyle) newDecor.push(style);
            itemSelecionado.style.textDecorationLine = newDecor.join(' ');
            button.classList.toggle('active', !hasStyle);
            if (itemSelecionado.style.textDecorationLine) {
                 itemSelecionado.style.textDecorationColor = 'inherit';
                 itemSelecionado.style.textDecorationStyle = 'solid';
            } else {
                 itemSelecionado.style.textDecoration = 'none';
            }
        }
        
        // --- Funções da Barra de Ferramentas de Estilo (Linha/Forma) ---

        function updateStyleToolState() {
            if (!itemSelecionado) return;
            
            if (itemSelecionado.classList.contains('item-linha')) {
                const linhaVisual = itemSelecionado.querySelector('.linha-visual');
                if (!linhaVisual) return;
                const style = window.getComputedStyle(linhaVisual);
                
                const color = style.backgroundColor === 'transparent' || style.backgroundColor === 'rgba(0, 0, 0, 0)' ? style.borderTopColor : style.backgroundColor;
                inputStyleColor.value = rgbToHex(color);
                
                const thickness = (style.height === 'auto' || style.height === '' || style.height === '0px') ? parseInt(style.borderTopWidth) : parseInt(style.height);
                inputStyleThickness.value = thickness || 1;
                
                selectStyleType.value = (style.borderTopStyle === 'none' || style.borderTopStyle === '') ? 'solid' : style.borderTopStyle;
                
                inputStyleThickness.disabled = false;
                selectStyleType.disabled = false;
            } else if (itemSelecionado.classList.contains('item-forma')) {
                const style = window.getComputedStyle(itemSelecionado);
                inputStyleColor.value = rgbToHex(style.backgroundColor); // Cor de preenchimento
                inputStyleThickness.value = parseInt(style.borderTopWidth) || 1;
                selectStyleType.value = style.borderTopStyle || 'solid';
                inputStyleThickness.disabled = false;
                selectStyleType.disabled = false;
            }
        }
        
        function applyLineStyle(styleType) {
             if (!itemSelecionado) return;
             const color = inputStyleColor.value;
             const thickness = inputStyleThickness.value + 'px';
             
             if (itemSelecionado.classList.contains('item-linha')) {
                const linhaVisual = itemSelecionado.querySelector('.linha-visual');
                if (!linhaVisual) return;

                if (styleType === 'solid') {
                    linhaVisual.style.borderTop = 'none'; // Remove border if solid
                    linhaVisual.style.backgroundColor = color;
                    linhaVisual.style.height = thickness;
                } else {
                    linhaVisual.style.backgroundColor = 'transparent'; // Transparent background for dashed/dotted
                    linhaVisual.style.borderTop = `${thickness} ${styleType} ${color}`;
                    linhaVisual.style.height = '0px'; // Border provides the height
                }
                // Store style properties for printing
                itemSelecionado.style.setProperty('--line-print-color', color);
                itemSelecionado.style.setProperty('--line-print-style', styleType);
             } else if (itemSelecionado.classList.contains('item-forma')) {
                 itemSelecionado.style.backgroundColor = color;
                 itemSelecionado.style.border = `${thickness} ${styleType} ${color}`;
             }
        }


        // --- Funções de Zoom ---
        function updateZoom() {
            paginaDeImpressao.style.transform = `scale(${zoomLevel})`;
        }

        // --- Event Listeners da Toolbar (Principal) ---

        btnAddEtiqueta.addEventListener('click', adicionarEtiqueta);
        
        btnZoomIn.addEventListener('click', () => {
            zoomLevel = Math.min(3.0, zoomLevel + 0.1); // Max zoom 3x
            updateZoom();
        });

        btnZoomOut.addEventListener('click', () => {
            zoomLevel = Math.max(0.2, zoomLevel - 0.1); // Min zoom 0.2x
            updateZoom();
        });

        btnZoomReset.addEventListener('click', () => {
            zoomLevel = 1.0;
            updateZoom();
        });

        // Modified listener for Duplicar
        btnDuplicarEtiqueta.addEventListener('click', () => {
             if (isDrawing) pararModoDesenho(false);
             if (!etiquetaAtiva) {
                 alertPersonalizado("Por favor, selecione a etiqueta que deseja duplicar.");
                 return;
             }
             showDuplicateCountModal(); // Show the new modal
        });
        
        // NOVO LISTENER para Remover Etiqueta
        btnRemoverEtiqueta.addEventListener('click', () => {
             if (isDrawing) pararModoDesenho(false);
             if (!etiquetaAtiva) {
                 alertPersonalizado("Por favor, selecione uma etiqueta para remover.");
                 return;
             }
             
             // Não permite remover a última etiqueta
             if (paginaDeImpressao.querySelectorAll('.etiqueta-editavel').length <= 1) {
                 alertPersonalizado("Não é possível remover a última etiqueta.");
                 return;
             }
             
             confirmPersonalizado("Tem certeza que deseja remover esta etiqueta e todo o seu conteúdo?", () => {
                 const proximaEtiqueta = etiquetaAtiva.nextElementSibling || etiquetaAtiva.previousElementSibling;
                 etiquetaAtiva.remove();
                 definirEtiquetaAtiva(proximaEtiqueta); // Ativa a próxima ou anterior
             });
        });

        
        btnImprimir.addEventListener('click', () => {
            desselecionarItem();
            if (isDrawing) pararModoDesenho(false);
            setTimeout(() => { window.print(); }, 50);
        });

        btnSalvar.addEventListener('click', salvarEtiqueta);

        // --- Funções de Salvar e Abrir ---

        function salvarEtiqueta() {
            if (isDrawing) pararModoDesenho(false);
            desselecionarItem();

            const dadosSalvos = {
                layout: {
                    width: inputCustomWidth.value,
                    height: inputCustomHeight.value,
                    cols: inputCustomCols.value,
                    preset: selectLayoutPreset.value
                },
                etiquetas: []
            };

            document.querySelectorAll('.etiqueta-editavel').forEach(etiquetaEl => {
                const itens = [];
                etiquetaEl.querySelectorAll('.item-arrastavel').forEach(itemEl => {
                    const tipo = Array.from(itemEl.classList).find(c => c.startsWith('item-') && c !== 'item-arrastavel').replace('item-', '');

                    const itemData = {
                        id: itemEl.id,
                        tipo: tipo,
                        style: itemEl.getAttribute('style'), // Salva todo o estilo inline
                        dataset: { ...itemEl.dataset } // Salva todos os data attributes
                    };

                    // Handle content-specific data
                    if (tipo === 'texto' || tipo === 'simbolo') {
                        itemData.conteudo = itemEl.innerHTML;
                    } else if (tipo === 'imagem') {
                        const img = itemEl.querySelector('img');
                        if (img) itemData.conteudo = img.src;
                    } else if (tipo === 'qrcode' || tipo === 'barcode') {
                        itemData.conteudo = itemEl.dataset.value; // Already stored
                    } else if (tipo === 'forma') {
                        itemData.shapeType = Array.from(itemEl.classList).find(c => c.startsWith('shape-')).replace('shape-', '');
                    } else if (tipo === 'linha') {
                         const linhaVisual = itemEl.querySelector('.linha-visual');
                         if(linhaVisual) itemData.linhaStyle = linhaVisual.getAttribute('style');
                    }

                    itens.push(itemData);
                });
                dadosSalvos.etiquetas.push({ id: etiquetaEl.dataset.labelId, itens: itens });
            });

            const dataStr = JSON.stringify(dadosSalvos, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'etiqueta.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alertPersonalizado('Etiqueta salva com sucesso!');
        }

        function abrirEtiqueta(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dados = JSON.parse(e.target.result);

                    // Limpa a página atual
                    paginaDeImpressao.innerHTML = '';
                    desselecionarItem();

                    // Restaura o layout
                    inputCustomWidth.value = dados.layout.width;
                    inputCustomHeight.value = dados.layout.height;
                    inputCustomCols.value = dados.layout.cols;
                    selectLayoutPreset.value = dados.layout.preset;
                    definirLayoutETamanho(dados.layout.preset);

                    // Recria as etiquetas e itens
                    dados.etiquetas.forEach((etiquetaData, index) => {
                        const novaEtiqueta = document.createElement('div');
                        novaEtiqueta.classList.add('etiqueta-editavel');
                        novaEtiqueta.dataset.labelId = etiquetaData.id;
                        paginaDeImpressao.appendChild(novaEtiqueta);

                        etiquetaData.itens.forEach(itemData => {
                            const item = document.createElement('div');
                            item.id = itemData.id;
                            item.className = `item-arrastavel item-${itemData.tipo}`;
                            item.setAttribute('style', itemData.style);

                            // Restore dataset
                            if (itemData.dataset) {
                                for (const key in itemData.dataset) {
                                    item.dataset[key] = itemData.dataset[key];
                                }
                            }

                            // Recreate content
                            if (itemData.tipo === 'texto' || itemData.tipo === 'simbolo') {
                                item.innerHTML = itemData.conteudo;
                                item.contentEditable = 'true';
                            } else if (itemData.tipo === 'imagem') {
                                const img = document.createElement('img');
                                img.src = itemData.conteudo;
                                img.draggable = false;
                                item.appendChild(img);
                            } else if (itemData.tipo === 'forma') {
                                item.classList.add(`shape-${itemData.shapeType}`);
                            } else if (itemData.tipo === 'linha') {
                                const linhaVisual = document.createElement('div');
                                linhaVisual.className = 'linha-visual';
                                linhaVisual.setAttribute('style', itemData.linhaStyle);
                                item.appendChild(linhaVisual);
                            }

                            novaEtiqueta.appendChild(item);

                            // Add rotation handle back
                            const rotateHandle = document.createElement('div');
                            rotateHandle.className = 'rotate-handle';
                            item.appendChild(rotateHandle);

                            inicializarInteracao(item);
                            addSelectionListeners(item);

                            // Special recreation for QR/Barcode
                            if (itemData.tipo === 'qrcode') {
                                const qrContainer = document.createElement('div');
                                item.appendChild(qrContainer);
                                new QRCode(qrContainer, { text: itemData.conteudo, width: 128, height: 128, correctLevel: QRCode.CorrectLevel.H });
                                const qrEl = qrContainer.querySelector('canvas') || qrContainer.querySelector('img');
                                if (qrEl) {
                                    qrEl.style.width = '100%';
                                    qrEl.style.height = '100%';
                                    qrEl.style.objectFit = 'contain';
                                }
                            } else if (itemData.tipo === 'barcode') {
                                const barcodeSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                                item.appendChild(barcodeSvg);
                                JsBarcode(barcodeSvg, itemData.conteudo, { format: "CODE128", displayValue: true, fontSize: 14, width: 2, height: 40, margin: 5 });
                                barcodeSvg.style.width = '100%';
                                barcodeSvg.style.height = '100%';
                                barcodeSvg.style.objectFit = 'fill';
                            }
                        });

                        if (index === 0) {
                            definirEtiquetaAtiva(novaEtiqueta);
                        }
                    });

                    alertPersonalizado('Etiqueta carregada com sucesso!');
                } catch (error) {
                    console.error("Erro ao carregar o arquivo:", error);
                    alertPersonalizado('Erro: O arquivo selecionado não é válido.');
                } finally {
                    // Reset file input to allow opening the same file again
                    event.target.value = null;
                }
            };
            reader.readAsText(file);
        }

        btnAbrir.addEventListener('click', () => {
            if (isDrawing) pararModoDesenho(false);
            confirmPersonalizado("Abrir um novo arquivo irá descartar quaisquer alterações não salvas. Deseja continuar?", () => {
                inputAbrirEtiqueta.click();
            });
        });

        inputAbrirEtiqueta.addEventListener('change', abrirEtiqueta);


        btnAddTexto.addEventListener('click', () => {
            const itemTexto = adicionarItem(etiquetaAtiva, 'texto');
            if(itemTexto) itemTexto.focus();
        });

        btnAddImagem.addEventListener('click', () => {
            if (!etiquetaAtiva) { alertPersonalizado("Selecione uma etiqueta primeiro!"); return; }
            if (isDrawing) pararModoDesenho(false);
            inputImagem.click();
        });

        btnRemoverItem.addEventListener('click', () => {
            if (itemSelecionado) {
                 confirmPersonalizado("Tem certeza que deseja remover este item?", () => {
                    itemSelecionado.remove();
                    desselecionarItem();
                 });
            }
        });

        inputImagem.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && etiquetaAtiva) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    adicionarItem(etiquetaAtiva, 'imagem', e.target.result);
                }
                reader.readAsDataURL(file);
            }
            event.target.value = null;
        });

        // --- Listeners das Novas Ferramentas ---
        
        selectAddShape.addEventListener('change', () => {
             const shapeType = selectAddShape.value;
             if (shapeType && etiquetaAtiva) {
                 adicionarItem(etiquetaAtiva, 'forma', shapeType);
                 selectAddShape.selectedIndex = 0; // Reset dropdown
             } else if (!etiquetaAtiva) {
                 alertPersonalizado("Selecione uma etiqueta primeiro!");
                 selectAddShape.selectedIndex = 0;
             }
        });
        
        btnAddLinha.addEventListener('click', () => {
            adicionarItem(etiquetaAtiva, 'linha');
        });
        
        btnAddSimbolo.addEventListener('click', () => {
             if (isDrawing) pararModoDesenho(false);
             modalSimbolos.style.display = 'flex';
        });
        
        modalSimbolosClose.addEventListener('click', () => {
             modalSimbolos.style.display = 'none';
        });
        
        // Listeners QR e Barcode
        btnAddQRCode.addEventListener('click', () => {
            if (isDrawing) pararModoDesenho(false);
            if (!etiquetaAtiva) { alertPersonalizado("Selecione uma etiqueta primeiro!"); return; }
            showInputModal("Digite o texto para o QR Code:", (data) => {
                if (data) addQRCode(data);
            });
        });
        
        btnAddBarcode.addEventListener('click', () => {
             if (isDrawing) pararModoDesenho(false);
             if (!etiquetaAtiva) { alertPersonalizado("Selecione uma etiqueta primeiro!"); return; }
             showInputModal("Digite o valor para o Cód. Barras:", (data) => {
                if (data) addBarcode(data);
            });
        });

        // Adicionar Lápis (Modo Desenho)
        btnAddLapis.addEventListener('click', () => {
            if (isDrawing) {
                pararModoDesenho(false); // Cancela o modo desenho se já estiver ativo
            } else if (etiquetaAtiva) {
                iniciarModoDesenho();
            } else {
                alertPersonalizado("Selecione uma etiqueta primeiro!");
            }
        });


        // --- Event Listener para Seleção de Etiqueta ---
        paginaDeImpressao.addEventListener('click', (event) => {
            const etiquetaClicada = event.target.closest('.etiqueta-editavel'); 
            
            if (etiquetaClicada && !isDrawing) { // Don't select labels while drawing
                definirEtiquetaAtiva(etiquetaClicada);
                // If click was directly on the label (not an item), deselect item
                if (!event.target.closest('.item-arrastavel') && event.target === etiquetaClicada) {
                    desselecionarItem();
                }
            } else if (!event.target.closest('#toolbar') 
                       && !event.target.closest('.secondary-toolbar') 
                       && !event.target.closest('#left-toolbar') // NOVO: Ignora cliques na barra esquerda
                       && !event.target.closest('.modal-overlay') 
                       && !isDrawing // Don't deselect if drawing
                       && !event.target.closest('.etiqueta-editavel')) { // Clicked outside labels too
                desselecionarItem();
            }
        });

        // --- Listener para Mudança de Tamanho/Layout ---
        selectLayoutPreset.addEventListener('change', (event) => {
            if (isDrawing) pararModoDesenho(false);
            definirLayoutETamanho(event.target.value);
        });
        
        // Listeners para inputs de layout personalizado
        function handleCustomLayoutChange() {
            if (isDrawing) pararModoDesenho(false); // Exit drawing if layout changes
            const w = parseFloat(inputCustomWidth.value);
            const h = parseFloat(inputCustomHeight.value);
            const c = parseInt(inputCustomCols.value, 10);
            if (w > 0 && h > 0 && c > 0) {
                aplicarLayout(w, h, c);
            } else {
                // Não alerta em cada 'input', espera 'change' ou botão
            }
        }
        // Mudar para 'change' para evitar alertas em tempo real
        inputCustomWidth.addEventListener('change', handleCustomLayoutChange);
        inputCustomHeight.addEventListener('change', handleCustomLayoutChange);
        inputCustomCols.addEventListener('change', handleCustomLayoutChange);
        
        
        // --- Event Listeners da Barra de Texto ---
        selectFontFamily.addEventListener('change', () => { if (itemSelecionado) itemSelecionado.style.fontFamily = selectFontFamily.value; });
        inputFontSize.addEventListener('input', () => { if (itemSelecionado) itemSelecionado.style.fontSize = inputFontSize.value + 'px'; });
        inputFontColor.addEventListener('input', () => { if (itemSelecionado) itemSelecionado.style.color = inputFontColor.value; });
        selectTextTransform.addEventListener('change', () => { if (itemSelecionado) itemSelecionado.style.textTransform = selectTextTransform.value; });
        btnTextBold.addEventListener('click', () => {
            if (itemSelecionado) {
                const style = window.getComputedStyle(itemSelecionado);
                const isBold = style.fontWeight === 'bold' || parseInt(style.fontWeight) >= 700;
                itemSelecionado.style.fontWeight = isBold ? 'normal' : 'bold';
                btnTextBold.classList.toggle('active', !isBold);
            }
        });
        btnTextItalic.addEventListener('click', () => {
            if (itemSelecionado) {
                const style = window.getComputedStyle(itemSelecionado);
                const isItalic = style.fontStyle === 'italic';
                itemSelecionado.style.fontStyle = isItalic ? 'normal' : 'italic';
                btnTextItalic.classList.toggle('active', !isItalic);
            }
        });
        btnTextUnderline.addEventListener('click', () => { toggleTextDecoration('underline', btnTextUnderline); });
        btnTextStrike.addEventListener('click', () => { toggleTextDecoration('line-through', btnTextStrike); });
        
        
        // --- Event Listeners da Barra de Estilo (Linha/Forma) ---
        inputStyleColor.addEventListener('input', () => {
             if (!itemSelecionado) return;
             const color = inputStyleColor.value;
             if (itemSelecionado.classList.contains('item-linha')) {
                 applyLineStyle(selectStyleType.value); // Use current style type
             } else if (itemSelecionado.classList.contains('item-forma')) {
                 itemSelecionado.style.backgroundColor = color;
                 itemSelecionado.style.borderColor = color; // Mudar borda junto
             }
        });
        inputStyleThickness.addEventListener('input', () => {
             if (!itemSelecionado) return;
             const thickness = inputStyleThickness.value + 'px';
             if (itemSelecionado.classList.contains('item-linha')) {
                 applyLineStyle(selectStyleType.value); // Reaplica com nova espessura
             } else if (itemSelecionado.classList.contains('item-forma')) {
                 itemSelecionado.style.borderWidth = thickness;
             }
        });
        selectStyleType.addEventListener('change', () => {
             if (!itemSelecionado) return;
             const styleType = selectStyleType.value;
             if (itemSelecionado.classList.contains('item-linha')) {
                 applyLineStyle(styleType); // Reaplica com novo estilo
             } else if (itemSelecionado.classList.contains('item-forma')) {
                 itemSelecionado.style.borderStyle = styleType;
             }
        });
        
        
        // --- Lógica do Modal de Símbolos ---
        function popularModalSimbolos() {
            const simbolos = [
                '★', '☆', '♡', '❤', '♪', '♫', '✔', '✖', '✅', '❌', '⚠', '⚡', '⚙',
                '❄', '🔥', '💧', '☀️', '☁️', '☂️', '▶', '◀', '⬆', '⬇', '♻', '™', '®', '©',
                '😀', '😂', '😍', '👍', '👎', '🎉', '🎁', '📞', '✉', '⏰', '🔒', '🔑', '💡',
                '💰', '💲', '🏷️', '📦', '🛒', '🌍', '🏠', '🏢', '🏭', '📌', '📅', '📊', '📈', '📉'
            ]; // Added more symbols
            symbolGridContainer.innerHTML = '';
            simbolos.forEach(simbolo => {
                const span = document.createElement('span');
                span.textContent = simbolo;
                span.onclick = () => {
                    adicionarItem(etiquetaAtiva, 'simbolo', simbolo);
                    modalSimbolos.style.display = 'none';
                };
                symbolGridContainer.appendChild(span);
            });
        }
        
        // --- Lógica do Modal de Input (QR/Barcode) ---
        function showInputModal(title, callback) {
            modalInputTitle.textContent = title;
            modalInputCallback = callback;
            modalInput.style.display = 'flex';
            modalInputField.value = '';
            modalInputField.type = 'text'; // Ensure it's text type
            modalInputField.focus();
        }
        modalInputSubmit.addEventListener('click', () => {
            if (modalInputCallback) {
                modalInputCallback(modalInputField.value);
            }
            modalInput.style.display = 'none';
            modalInputCallback = null;
        });
        modalInputClose.addEventListener('click', () => {
            modalInput.style.display = 'none';
            modalInputCallback = null;
        });

        // --- Lógica do Modal de Contagem de Duplicação ---
        function showDuplicateCountModal() {
            modalDuplicateField.value = '1'; // Reset to 1
            modalDuplicateCount.style.display = 'flex';
            modalDuplicateField.focus();
            modalDuplicateField.select(); // Select the text
        }
        modalDuplicateSubmit.addEventListener('click', () => {
            const count = parseInt(modalDuplicateField.value, 10);
            if (count > 0 && count <= 100) { // Add a reasonable limit
                duplicarEtiqueta(count);
                modalDuplicateCount.style.display = 'none';
            } else {
                alertPersonalizado("Por favor, insira um número entre 1 e 100.");
            }
        });
        modalDuplicateClose.addEventListener('click', () => {
            modalDuplicateCount.style.display = 'none';
        });

        
        // --- Lógica de Desenho (Lápis e Borracha) ---
        
        function iniciarModoDesenho() {
            if (!etiquetaAtiva) return;
            
            isDrawing = true;
            btnAddLapis.classList.add('active'); // Highlight pencil button
            desselecionarItem(); // Deselect any selected item
            drawingToolbarOptions.style.display = 'flex'; // Show drawing tools
            
            // Set default tool (pencil)
            btnDrawToolPencil.classList.add('active');
            btnDrawToolEraser.classList.remove('active');
            
            // Create canvas overlay
            drawCanvas = document.createElement('canvas');
            drawCanvas.id = 'draw-canvas-overlay';
            // Match canvas size to label size
            drawCanvas.width = etiquetaAtiva.offsetWidth; 
            drawCanvas.height = etiquetaAtiva.offsetHeight;
            etiquetaAtiva.appendChild(drawCanvas); // Append directly to the active label
            
            drawCtx = drawCanvas.getContext('2d');
            // Set initial drawing styles
            drawCtx.strokeStyle = inputDrawColor.value;
            drawCtx.lineWidth = inputDrawThickness.value;
            drawCtx.lineCap = 'round'; // Smooth line ends
            drawCtx.lineJoin = 'round'; // Smooth line corners
            drawCtx.globalCompositeOperation = 'source-over'; // Default: Pencil mode
            
            let painting = false; // Flag to track if mouse/touch is down

            // Function to get accurate coordinates relative to the canvas
            function getMousePos(evt) {
                 const rect = drawCanvas.getBoundingClientRect();
                 // Handle both mouse and touch events
                 const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
                 const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
                 // Adjust for canvas scaling if its display size differs from its internal resolution
                 const scaleX = drawCanvas.width / rect.width;
                 const scaleY = drawCanvas.height / rect.height;
                 return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                 };
            }
            // Event handler when drawing starts (mousedown/touchstart)
            drawListeners.start = function(e) {
                e.preventDefault(); // Prevent default actions (like scrolling on touch)
                painting = true;
                const pos = getMousePos(e);
                drawCtx.beginPath(); // Start a new path
                drawCtx.moveTo(pos.x, pos.y); // Move to the starting point
            }
            // Event handler when drawing ends (mouseup/touchend/mouseleave)
            drawListeners.end = function() {
                if (!painting) return;
                painting = false;
                drawCtx.beginPath(); // Reset path
            }
            // Event handler while drawing (mousemove/touchmove)
            drawListeners.draw = function(e) {
                e.preventDefault();
                if (!painting) return;
                const pos = getMousePos(e);
                drawCtx.lineTo(pos.x, pos.y); // Draw a line to the new point
                drawCtx.stroke(); // Render the line segment
                drawCtx.beginPath(); // Inicia novo caminho para o próximo segmento
                drawCtx.moveTo(pos.x, pos.y); // Move para o ponto atual
            }

            // Attach Event Listeners for Mouse and Touch
            drawCanvas.addEventListener('mousedown', drawListeners.start);
            drawCanvas.addEventListener('mouseup', drawListeners.end);
            drawCanvas.addEventListener('mouseleave', drawListeners.end); // Stop drawing if mouse leaves canvas
            drawCanvas.addEventListener('mousemove', drawListeners.draw);
            
            drawCanvas.addEventListener('touchstart', drawListeners.start, { passive: false }); // Use passive: false to allow preventDefault
            drawCanvas.addEventListener('touchend', drawListeners.end);
            drawCanvas.addEventListener('touchcancel', drawListeners.end); // Handle interruption
            drawCanvas.addEventListener('touchmove', drawListeners.draw, { passive: false });
            
            // Add "Concluir Desenho" button dynamically
            if (!btnConcluirDesenho) { // Create only if it doesn't exist
                btnConcluirDesenho = document.createElement('button');
                btnConcluirDesenho.id = 'btn-concluir-desenho';
                btnConcluirDesenho.textContent = 'Concluir Desenho';
                btnConcluirDesenho.onclick = () => pararModoDesenho(true); // Save drawing on click
                document.body.appendChild(btnConcluirDesenho);
            }
        }
        
        // Function to stop drawing mode (CORRIGIDO)
        function pararModoDesenho(salvar = true) {
             if (!isDrawing) return; // Exit if not drawing
             
             if (salvar && drawCanvas) {
                // Check if canvas is not blank before saving
                if (!isCanvasBlank(drawCanvas)) {
                    const dataURL = drawCanvas.toDataURL('image/png'); // Get drawing as PNG
                    adicionarItem(etiquetaAtiva, 'imagem', dataURL); // Add as a new image item
                }
             }
             
             // Cleanup
             isDrawing = false;
             btnAddLapis.classList.remove('active'); // Deactivate pencil button
             drawingToolbarOptions.style.display = 'none'; // Hide drawing tools
             if(drawCanvas) {
                // Remove listeners que foram salvos
                drawCanvas.removeEventListener('mousedown', drawListeners.start);
                drawCanvas.removeEventListener('mouseup', drawListeners.end);
                drawCanvas.removeEventListener('mouseleave', drawListeners.end);
                drawCanvas.removeEventListener('mousemove', drawListeners.draw);
                drawCanvas.removeEventListener('touchstart', drawListeners.start);
                drawCanvas.removeEventListener('touchend', drawListeners.end);
                drawCanvas.removeEventListener('touchcancel', drawListeners.end);
                drawCanvas.removeEventListener('touchmove', drawListeners.draw);
                drawCanvas.remove(); // Remove canvas from DOM
             }
             if(btnConcluirDesenho) {
                btnConcluirDesenho.remove(); // Remove "Concluir" button
                btnConcluirDesenho = null; // Reset variable
             }
             drawCanvas = null; // Reset variable
             drawCtx = null; // Reset variable
             drawListeners = { start: null, end: null, draw: null }; // Limpa listeners
        }

        // Helper function to check if canvas is blank (all transparent pixels)
        function isCanvasBlank(canvas) {
            if (!canvas) return true;
            const context = canvas.getContext('2d');
            try {
                const pixelBuffer = new Uint32Array(
                    context.getImageData(0, 0, canvas.width, canvas.height).data.buffer
                );
                // Check if any pixel has non-zero alpha
                return !pixelBuffer.some(color => (color & 0xff000000) !== 0);
            } catch (e) {
                console.error("Error checking canvas blank state:", e);
                return false; // Assume not blank if error occurs (e.g., tainted canvas)
            }
        }

        // Listeners for Drawing Toolbar
        inputDrawColor.addEventListener('input', () => { if(drawCtx) drawCtx.strokeStyle = inputDrawColor.value; });
        inputDrawThickness.addEventListener('input', () => { if(drawCtx) drawCtx.lineWidth = inputDrawThickness.value; });
        
        btnDrawToolPencil.addEventListener('click', () => {
            if(drawCtx) drawCtx.globalCompositeOperation = 'source-over'; // Set draw mode
            btnDrawToolPencil.classList.add('active');
            btnDrawToolEraser.classList.remove('active');
        });
        
        btnDrawToolEraser.addEventListener('click', () => {
            if(drawCtx) drawCtx.globalCompositeOperation = 'destination-out'; // Set erase mode
            btnDrawToolPencil.classList.remove('active');
            btnDrawToolEraser.classList.add('active');
        });


        // --- Funções de Alerta/Confirmação Personalizadas ---
        function alertPersonalizado(message) {
             confirmPersonalizado(message, null, true);
        }
        function confirmPersonalizado(message, onConfirm, isAlert = false) {
            document.querySelector('.modal-overlay-confirm')?.remove(); // Remove previous confirm modals
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay modal-overlay-confirm'; // Specific class for confirmation
            overlay.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;`;
            const modal = document.createElement('div');
            modal.style.cssText = `background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 400px; text-align: center; font-family: inherit;`;
            const msgElement = document.createElement('p');
            msgElement.textContent = message;
            msgElement.style.cssText = 'margin: 0 0 20px; font-size: 1.1em; color: #333;';
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = 'display: flex; justify-content: center; gap: 15px;';
            const btnOK = document.createElement('button');
            btnOK.textContent = isAlert ? 'OK' : 'Confirmar';
            btnOK.style.cssText = `background-color: #1a73e8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: 500; transition: background-color 0.2s;`;
            btnOK.onmouseover = () => btnOK.style.backgroundColor = '#185abc';
            btnOK.onmouseout = () => btnOK.style.backgroundColor = '#1a73e8';
            btnOK.onclick = () => {
                if (onConfirm) onConfirm();
                overlay.remove();
            };
            buttonContainer.appendChild(btnOK);
            if (!isAlert) { // Only add Cancel button if it's not just an alert
                const btnCancel = document.createElement('button');
                btnCancel.textContent = 'Cancelar';
                btnCancel.style.cssText = `background-color: #f1f3f4; color: #3c4043; border: 1px solid #dadce0; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.2s;`;
                btnCancel.onmouseover = () => btnCancel.style.backgroundColor = '#e8eaed';
                btnCancel.onmouseout = () => btnCancel.style.backgroundColor = '#f1f3f4';
                btnCancel.onclick = () => overlay.remove();
                buttonContainer.appendChild(btnCancel);
            }
            modal.appendChild(msgElement);
            modal.appendChild(buttonContainer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }


        // --- Inicialização ---
        definirLayoutETamanho(selectLayoutPreset.value); // Apply initial layout based on dropdown
        document.querySelectorAll('.item-arrastavel').forEach(inicializarInteracao); // Initialize existing items (if any)
        btnRemoverItem.style.display = 'none'; // Hide remove button initially
        popularModalSimbolos(); // Populate the symbol modal
        selectAddShape.selectedIndex = 0; // Ensure "Forma" placeholder is selected

        // --- Listener para Deletar com Teclado (NOVO) ---
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Delete' || e.key === 'Backspace') {
                const target = e.target;
                const isEditing = target.tagName === 'INPUT' || 
                                  target.tagName === 'SELECT' || 
                                  target.isContentEditable;

                if (isEditing) return; // Não faz nada se estiver editando

                e.preventDefault(); // Impede o navegador de voltar (Backspace)

                if (itemSelecionado) {
                    // Se um item está selecionado, remove o item
                    confirmPersonalizado("Tem certeza que deseja remover este item?", () => {
                        itemSelecionado.remove();
                        desselecionarItem();
                    });
                } else if (etiquetaAtiva) {
                    // Se nenhum item, mas uma etiqueta está ativa, remove a etiqueta
                    btnRemoverEtiqueta.click(); // Reutiliza a lógica do botão
                }
            }
        });

        // --- Listener para Zoom com Scroll (NOVO) ---
        document.addEventListener('wheel', (e) => {
            if (e.altKey) {
                e.preventDefault(); // Impede a rolagem da página
                if (e.deltaY < 0) {
                    // Scroll para cima, aumenta o zoom
                    btnZoomIn.click();
                } else {
                    // Scroll para baixo, diminui o zoom
                    btnZoomOut.click();
                }
            }
        }, { passive: false }); // Necessário para que preventDefault funcione

    </script>
</body>
</html>
